## Your guide to launching software at TTS

## Overview

The goal of this guide is to provide TTS staff with the information they need to launch software from a technical and compliance perspective. It explains requirements and best practices for projects at TTS, and the process of obtaining an ATO.

**Read this guide early and often**, especially when you're starting to consider a future project launch or feature release. **This isn't a last-minute pre-launch checklist.**

## General Security Stanards

In the Federal government, the principal law governing the security of information systems is the Federal Information Security Management Act (FISMA). For more information on FISMA, check out the [FISMA Ready introduction](https://github.com/fisma-ready/introduction), a community project co-managed by TTS. Cloud.gov and the [TTS Tech Portfolio](https://handbook.18f.gov/tech-portfolio/) team have done most of the heavy lifting with regards to FISMA, but it is still important to understand the context into which we ship.

Here are a few pointers to get you started:

- DevOps isn't a team at TTS, but a skillset. We are all responsible for the security and operations of our systems.
- The security of our users' information is paramount, even moreso when it is personally identifiable information (PII). The types of information your system may process helps determine the type of ATOs available to you and [whether or not you will need to conduct a Privacy Impact Assessment (PIA).
- Be wary of systems that:
  - trust unsanitized information from the internet
  - do not encrypt data, both at rest and in transit
  - may be subject to privilege escalation
  - other items from the [OWASP Top 10](https://www.owasp.org/index.php/Category:OWASP_Top_Ten_Project)

### Multi-factor Authorization

All TTS systems requiring authentication **must** use multiple factors. Examples of multi-factor authentication (MFA) include, but are not limited to:

- [**cloud.gov identity provider**](https://cloud.gov/docs/services/cloud-gov-identity-provider/)
- [**GSA SecureAuth**](https://insite.gsa.gov/portal/content/651806) - only an option when your users have GSA ENT accounts
- [**OMB Max**](https://max.gov/) - requires an Inter-Agency Agreement
- [**Login.gov**](https://login.gov) - requires an Memorandum of Understanding for new agencies

## Lifecycle of a Launch

### Timeline

ATO Sprints are staffed by cross-divisionally by the GSA Office of the Chief Information Security Officer (OCISO) and TTS.

There are a few factors that will determine how long it takes a project to get an ATO.

- Everything in Phase 1 needs to be done before the project can enter the ATO Sprint. That responsibility is on the project team and the respective TTS Tech Portfolio Lead. Completing Phase 1 could take 40 hours of work.
- Your TTS Tech Portfolio Lead conducts the documentation review of Phase 2. Projects are scheduled forPhase 3 by the TTS Tech Portfolio Leads as a group.
- Phase 3 should take two weeks, assuming the previous Phases were done thoroughly.

**The ATO Sprinting Team makes no _guarantees_ regarding the timeline of ATOs.**

### Steps

Some TTS-specific information beyond the **general steps**:

#### Step 0

As soon as you begin developing an alpha, create your ATO checklistto set up a tracking mechanism for your ATO. You can ask questions in your checklist thread to understand the specific considerations for your system. At this time it is also good to ensure your system is eligible for pre-assessment authorization for user testing purposes.

#### Step 1

Work with your TTS Tech Portfolio Lead to categorize your system's impact levels, using the ATO Levels guide. GSA provides a "lightweight" ATO process designed for pilot systems running on GSA authorized infrastructure, for which fewer controls are in scope.

#### Step 3

Work together with your TTS Tech Portfolio Lead on this step. The documentation generated by similar TTS projects can be helpful at this stage. Consult the checklist for examples. SSP templates are available for both GSA LATOs and FedRAMP ATOs.

#### Step 4

The first step in doing so is to run the security scans. This is a preliminary assessment, final assessment will be done in collaboration with GSA OCISO. You are encouraged to run scans yourself, so that there aren't big surprises during the ATO Sprint.

In parallel, you will collaborate with a GSA OCISO assessor to verify all the controls in the SSP. 

#### Step 5

Your TTS Tech Portfolio Lead will work with you to schedule and prioritize your system assessment. Once assessment starts, the first step is that the AO will review all the items in your ATO checklist including all the documents you generated.

Then, for most systems, a team with members from the project team, your AO, your TTS Tech Portfolio Lead, and the GSA OCISO will convene for at least a week as the ATO Sprinting Team, and begin to follow the Lightweight Security Authorization Guide https://insite.gsa.gov/topics/information-technology/security-and-privacy/it-security/it-security-procedural-guides.

Folks from OCISO will conduct a penetration test on the system. Any penetration test findings deemed serious enough to prevent an ATO will need to be fixed right away to unblock the ATO process. They will also review the SSP document and test the control narratives. This testing and review process will take 1-2 weeks and should be the top priority for the project team at the time.

#### Step 6

There are several ways to ensure that your system remains compliant:

- Act on any security notifications from your static analysis.
- Perform and act on findings from dynamic scanning.
- Re-certify your Privacy Threshold Analysis (PTA).

### Re-authorization

Beyond the [**general information**](https://atos.open-control.org/overview/#re-authorization):

If you're planning a change that you think may require re-authorization, please open an issue in the TTS Tech Portfolio repository to explain your planned change, so they can evaluate it.

If your systems needs re-authorization, follow the usual steps for getting an ATO, starting with the checklist. You should be able to reuse most of your existing ATO materials, assuming they have been kept up-to-date.

### ATO renewal

Beyond the [**general information**](https://atos.open-control.org/overview/#ato-renewal), follow the usual steps for getting an ATO, starting with [the checklist](checklist/).

## Types of ATO

In most cases, the types of ATO that will be pursued for GSA systems are the *GSA Lightweight ATO (LATO)*. The GSA LATO process is described in a guide on [Insite](https://insite.gsa.gov/topics/information-technology/security-and-privacy/it-security/it-security-procedural-guides) (search for "Lightweight Security Authorization Guide" on that page). Systems that are under development must fulfill the requirements for [pre-assessment for internal government use](#conditions-for-pre-assessment).

The GSA LATO is designed for **Low** and **Moderate** impact level systems built using agile methods that run on top of cloud infrastructure which has already received an ATO (such as AWS, Azure, and [cloud.gov](https://cloud.gov)). It is "lightweight" because it represents a tailored subset of the hundreds of controls in NIST Special Publication (SP) 800-53.

 **Low** risk system ATOs are valid for 3 years. **Moderate** risk system ATOs are valid for 1 year. The Authorizing Official (AO) and Chief Information Security Officer (CISO) may sometimes grant a 90-day ATO, on a case by case basis. The default expectation is to avoid 90-day ATOs whenever possible, since they make more work for everyone.

### Conditions for pre-assessment

_Previously known as "pre-authorization"._

You may operate without further authorization, based on our approved pre-existing security authorization, if all of the following conditions are met:

* The system is deployed to [cloud.gov](https://cloud.gov) or the 18F AWS East/West environment.
* The system does _not_:
    * interact with or change the state of any production Federal information system, whether it is operated by TTS or our Federal partners
    * collect or store any sensitive personally identifiable information (PII)
    * is not the canonical source of any "production" data
* The system is _only_ available to:
    * staff of the General Services Administration
    * other Federal staff / agencies, by one of:
        * IP CIDR block
        * some kind of auth mechanism
            * HTTP Basic Auth (one set of credentials shared amonst the team is fine)
            * OAuth ([cloud.gov authentication](https://docs.cloud.gov/apps/leveraging-authentication/), or [GitHub authentication](https://developer.github.com/v3/oauth/) limited to a particular organization)
            * etc.

For systems where _all_ of the information in the system is already publicly available and is non-confidential, the last step can be skipped once you have begun your ATO assesment with GSA IT.


Systems in the pre-assessment phase do not require MFA.


## Security Scanning

Security scanning is separated into a few categories:

* Static: Static Code Analysis (SCA) is similar to the [linters](https://en.wikipedia.org/wiki/Lint_(software)) that many developers use on a day-to-day basis. While many linters focus on stylistic concerns, we are interested in those tools that target security flaws.
* Dynamic:
    * Active
        * Antivirus and malware scanning
        * Infrastructure-level scan (done at the cloud.gov level)
        * Penetration test
    * Passive: Monitors network traffic, but does not generate its own traffic.

## Alerts

Alerts come in one of four categorizations:

* **Low** and **Medium** can be resolved after the ATO is granted.
* **High** and **Critical** must be resolved before the ATO is granted.

Any false positives should be documented as such, through an "ignore" file (e.g. with a `note` in [Brakeman](http://brakemanscanner.org/docs/ignoring_false_positives/)) or with your ATO-related documentation.

## ATO Scanning

### Getting ready to scan

The system's technical stack needs to be relatively stable before authorization.

If, during testing, the system performs:

* user authentication or authorization
* back-end administrative functions
* encryption

...then those features must be *complete* before an authorization will be given. Note that the use of common web frameworks and [18F HTTPS standards](https://github.com/18F/https) resolves these issues in almost every case.

Ensure that your site is scannable by automated tools. For example, if you have a single-page app use the pushState to make site URLs friendly to automated tools.

Lastly, make sure the `README` file in your repo is fully up to date and clearly explains what the system does and why at a high level. You should also include the above information in your `README`.

### Greybox testing

Once you are ready, the [GSA OCISO](https://insite.gsa.gov/portal/content/527517) team will start both automated and manual scanning and testing. This includes:

* web vulnerability scanning on the front-end
* static code analysis on the `master` branch of your repo
* for higher FISMA levels, penetration testing by third party security consultants.

For greybox testing, the testing team has significant (but not necessarily complete) knowledge of how the system works, as opposed to black box testing, where they have zero knowledge, or white box testing, where they have complete knowledge.

All of these tests must be conducted on an environment that is _identical to production_ and ideally is set up specifically for this scanning process. This also requires creating a stable `release` branch. You can continue working on `master` and deploy builds from `master` to a development environment.

### Expectation management

Overall, if *no* vulnerabilities are found, this process has been taking approximately 2 weeks for test preparation and System Security Plan writing and 2 weeks for greybox testing and [signature](https://atos.open-control.org/steps/#step-5-authorize-information-system). FISMA Moderate and FISMA High will require additional time.

Since the time it would take to resolve vulnerabilities is not known until a vulnerability is identified, it is **strongly recommended** that no expectations are set with Federal partners or GSA stakeholders when public testing will begin. Instead, we recommend that the authorization process is seen as part of the delivery process and your definition of "done".

After the system has been authorized, you can then begin planning a public roll out of your system.

## Static Analysis

Static analysis is an important part of the development process, and is required for ATO. There are two main types of static security testing that needs to be done:

- **Dependency analysis**, where the Ruby gems, Python modules, and JavaScript packages your app uses are checked against a list of known vulnerabilities.
- **Code security analysis**, in which your code is checked against a list of antipatterns.

There are tools for JS, Ruby, and Python, and you are encouraged to set up this scanning early on in the development cycle to prevent unexpected delays when it's time to get your ATO. Note that there are _many_ tools out there for doing code style linting - see the [18F Development Guide](https://github.com/18F/development-guide) for recommendations. This page is specifically security-focused.

## Recommendations by language

| Language   | Dependency analysis                          | Code security analysis                                                                                                                                                                                                                                   |
| ---------- | -------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Go         | [Snyk](https://snyk.io/docs/snyk-for-golang) | [Go Meta Linter](https://github.com/alecthomas/gometalinter), with the security-related [linters](https://github.com/alecthomas/gometalinter#supported-linters) (like [SafeSQL](https://github.com/stripe/safesql), if you're doing SQL queries) enabled |
| JavaScript | [GitHub][github-alerts]<sup>\*</sup>         | [eslint-config-scanjs](https://www.npmjs.com/package/eslint-config-scanjs) / [eslint-plugin-security](https://www.npmjs.com/package/eslint-plugin-security)                                                                                              |
| Python     | [GitHub][github-alerts]<sup>\*</sup>         | [Bandit](https://github.com/openstack/bandit) with the provided [config file](https://github.com/18F/compliance-toolkit/blob/master/configs/static/.bandit); [engine for Code Climate](https://docs.codeclimate.com/docs/bandit)                         |
| Ruby       | [GitHub][github-alerts]<sup>\*</sup>         | [Code Climate](https://docs.codeclimate.com/v1.0/docs/brakeman) or [Hakiri](https://hakiri.io/) - _Rails only_                                                                                                                                           |

\* Enabled automatically for repositories in [TTS GitHub organizations](https://handbook.18f.gov/github/#organizations) through [`ghad`](https://github.com/18F/ghad).

## Dependency analysis

Use one of the services above, which should support adding public repositories yourself. If you need scanning on a private repository, file an issue in the TTS Tech Portoflio repo.

### Snyk

When starting a new project for an agency partner, consider [creating a new Snyk organization](https://snyk.io/docs/orgs#creating-a-new-organisation) for your project and [invite the agency partners (in addition to the TTS team)](https://snyk.io/docs/orgs#collaborating-with-team-members). This will facilitate the project's hand-off in the future.

For repositories which include multiple dependency manifests (e.g. due to multiple sub-projects or crossing languages), be sure to configure Snyk to track each dependency file. By default, Snyk's import will stop after finding the first dependency manifest.

## Code analysis

This is commonly referred to as "static analysis". Code analysis can be done by a service recommended, or within your existing continuous integration tool. Additional configuration information available below.

### Config files

Basic config files for some static analysis tools can be found in the [compliance-toolkit repo](https://github.com/18F/compliance-toolkit. These currently are little more than the default settings, but the recommendations may change. If you find a test that you believe is invalid, file an issue in the repo.

We are especially interested to know if you get lots of false positives. We believe the default config files will grow and evolve, but the most up-to-date versions will always be found in the repo.

More advanced configuration options for all the tools can be found in their respective docs.

[github-alerts]: https://help.github.com/en/articles/about-security-alerts-for-vulnerable-dependencies#alerts-and-automated-security-fixes-for-vulnerable-dependencies

## Dynamic Scanning

In order for an application to get ATO, it needs to meet more than a minimum level of application security, so the application team needs to run both static and dynamic security scans) and document good results. Running a "dynamic" scan means running a program that analyzes a live running application for common vulnerabilities.

As part of the process of getting an ATO at TTS, **your application team will need to set up [OWASP ZAP](https://www.owasp.org/index.php/OWASP_Zed_Attack_Proxy_Project) to do dynamic vulnerability scanning of your application**. ZAP can function as either an active (Spider & Attack options) or a passive (man-in-the-middle/proxy) scanner, but is usually used as a combination of both. If you (or another person on your application team) has questions about setting this up, ask #infrastructure for help.

## Preface

You will need a running application to test, which you will want to be as production-like as possible—ideally a staging environment. Running a scan can cause a spike in requests and errors, so **inform your team and [#infrastructure](https://gsa-tts.slack.com/messages/infrastructure/) if you are going to run it on a production site.**

We gave an introduction to ZAP talk as part of our engineering tech talks series.

<iframe width="420" height="315" src="https://www.youtube.com/embed/2Dp7pAvKHaM" frameborder="0" allowfullscreen></iframe>

Using the the [Quick Start](https://github.com/zaproxy/zap-core-help/wiki/HelpAddonsQuickstartQuickstart) is a good way to get a basic idea of what ZAP does.

## Scanning

1. [Set up ZAP as a proxy.](https://github.com/zaproxy/zap-core-help/wiki/HelpStartProxies)
   - If the browser gives you a certificate error (e.g. `"This site uses HTTP Strict Transport Security (HSTS) to specify that Firefox may only connect to it securely."`), you will need to install ZAP's root certificate.
     - In ZAP, go to `Tools`->`Options`->`Dynamic SSL Certificate` and click the `Save` button to save the certificate to your computer.
     - You will then need to install the certificate. For Firefox, go to `Preferences`->`Advanced`>`Certificates`->`View Certificates`->`Import` to import the certificate you saved from ZAP.
     - For additional information see ZAP's [documentation on Dynamic SSL Certificates](https://github.com/zaproxy/zap-core-help/wiki/HelpUiDialogsOptionsDynsslcert).
1. Seed the scanner.
   1. Navigate through the various types of pages/interactions on your site, including signing in. You should see domain name(s) start to show up under the `Sites` list.
   1. For each of the domains in the `Sites` list that you control (i.e. not `https://fonts.googleapis.com`):
      1. Right-click the domain to bring up the context menu.
      1. Select `Include in Context`->`Default Context`.
      1. In the `Session Properties` window that pops up, click `OK`.
1. Run the spider.
   1. In the menu bar, click `Tools`->`Spider...`.
   1. Click `New Scan`.
   1. Next to `Starting point`, click `Select...`.
   1. In the `Select Node` window, click `Default Context`, the `Select`.
   1. Click `Start Scan`.
   1. You should see the `Spider` table fill up with results, but the domains you don't control should say `OUT_OF_CONTEXT`.
1. If your site uses AJAX, run the [AJAX Spider](https://github.com/zaproxy/zap-core-help/wiki/HelpAddonsSpiderAjaxConcepts).
1. Run the actual scan.
   1. In the menu bar, click `Tools`->`Active Scan...`.
   1. In the `Active Scan` window, follow the same `Starting point` steps as above.
1. View the alerts.
   1. Click the `Alerts` tab.
   1. Above the `Alerts` list, click the ![target icon](../../assets/images/zap_target.png) (so that it turns red) to `Show only URLs in scope`.
1. [Investigate the listed alerts.](#alerts)
1. Export the results.
   1. In the menu bar, go to `Report` -> `Generate HTML Report`.

## Examining the Results

### The Spider

As configured, the Spider does not follow links to other domains or subdomains. If your project uses either (for example, you use S3 for assets, or the api is at a different sub domain), you will want to click and update the options to include the domains & subdomains within the scope. There is a guide available for those options [here](https://github.com/zaproxy/zap-core-help/wiki/HelpUiDialogsOptionsSpider).

### Alerts

The Alerts pane lists all alerts discovered while scanning the site. As described on the alerts page, the red and orange-flagged alerts must be taken care of before the application can be ATO'd. You have a little more flexibility when dealing with the yellow and blue flags, but all of them must be either corrected or, in the case of false positives, documented.

Optional: When you get false positives, you can [file issues with the ZAP project](https://github.com/zaproxy/zaproxy/issues?utf8=%E2%9C%93&q=is%3Aissue+is%3Aopen+false+positive) to help them improve the alerting rules to prevent false positives.

If you're running the attack against a local server you may see some alerts that you wouldn't see on cloud.gov. Debugging web servers are more 'chatty' about errors than production servers.

## Other Tools Within ZAP

### Fuzzing

["Fuzzing"](https://en.wikipedia.org/wiki/Fuzz_testing) refers to feeding a large amount of random (and/or potentially malicious) data to an application with the intention of finding vulnerabilities related to poor error handling or incomplete input validation. Typically, fuzzing is used on query parameters and form fields.

Any request in ZAP can be fuzzed. Simply right click on it, select Attack -> Fuzzer. Read more about ZAP's Fuzzing capabilities [here](https://github.com/zaproxy/zap-core-help/wiki/HelpAddonsFuzzConcepts).

## More Information

The [ZAP User Guide](https://github.com/zaproxy/zap-core-help/wiki) is phenomenal. If you run into an issue, this should be the first place you check.

The [OWASP Vulnerable Web Applications Directory](https://www.owasp.org/index.php/OWASP_Vulnerable_Web_Applications_Directory_Project#tab=Main) has a great list of (intentionally) vulnerable targets that are useful for testing the capability of ZAP.


## Code Frameworks


Organized by language.

### [Node.js](https://nodejs.org/)

* See info on JavaScript [static security analysis](../static-analysis/#recommendations-by-language)

#### [Express](https://expressjs.com/)

* [Express Production Best Practices: Security](https://expressjs.com/en/advanced/best-practice-security.html)

#### [Sails](http://sailsjs.org/)

* [Sails Security](http://sailsjs.org/documentation/concepts/security)

### [Python](https://www.python.org/)

#### [Django](https://www.djangoproject.com/)

* Set up [static security analysis](../static-analysis/#recommendations-by-language).
* Read through the official [deployment checklist](https://docs.djangoproject.com/en/stable/howto/deployment/checklist/).

See also:

* [OWASP Django Secure Configuration Guide](https://www.owasp.org/index.php/SCG_WF_Django)
* Search [this deck](https://speakerdeck.com/mpirnat/shiny-lets-be-bad-guys-exploiting-and-mitigating-the-top-10-web-app-vulnerabilities-oscon-2016-edition) (click "Download PDF") for "Django"
* Jacob Kaplan-Moss' talk: [Python vs. the OWASP Top 10](https://www.youtube.com/watch?v=sra9x44lXgU) ([slides](https://speakerdeck.com/jacobian/python-vs-the-owasp-top-10))
* [Security in Django](https://docs.djangoproject.com/en/1.10/topics/security/)

#### [Flask](http://flask.pocoo.org/)

* Set up [static security analysis](../static-analysis/#recommendations-by-language)
* Read through the [official security docs](http://flask.pocoo.org/docs/security/)
* Consider using [Flask-Security](https://pythonhosted.org/Flask-Security/)

See also:

* Search [this deck](https://speakerdeck.com/mpirnat/shiny-lets-be-bad-guys-exploiting-and-mitigating-the-top-10-web-app-vulnerabilities-oscon-2016-edition) (click "Download PDF") for "Flask"
* Jacob Kaplan-Moss' talk: [Python vs. the OWASP Top 10](https://www.youtube.com/watch?v=sra9x44lXgU) ([slides](https://speakerdeck.com/jacobian/python-vs-the-owasp-top-10))

### [Ruby](https://www.ruby-lang.org/)

#### [Rails](http://rubyonrails.org/)

* Set up [static security analysis](../static-analysis/#recommendations-by-language).
* Read through [Secure Rails](https://github.com/ankane/secure_rails).
* If you need authorization, consider using the gems listed below. Use the linked instructions to ensure you have authorization applied to all appropriate controller actions.
    * [CanCanCan](https://github.com/CanCanCommunity/cancancan#4-lock-it-down)
    * [Pundit](https://github.com/elabs/pundit#ensuring-policies-and-scopes-are-used)

More info:

* [Rails Security Guide](http://guides.rubyonrails.org/security.html)
* [OWASP Rails Cheatsheet](https://www.owasp.org/index.php/Ruby_on_Rails_Cheatsheet)

#### [Sinatra](http://www.sinatrarb.com/)/[Padrino](http://padrinorb.com/)

* Set up [static security analysis](../static-analysis/#recommendations-by-language). We are currently seeking recommendations for this configuration.
* Ensure that [rack-protection](https://github.com/sinatra/rack-protection) and/or [SecureHeaders](https://github.com/twitter/secureheaders) is enabled and configured.

More info:

* [Rails Security Guide](http://guides.rubyonrails.org/security.html) is not directly related, but contains pertinent information and descriptions of common vulnerabilities.



